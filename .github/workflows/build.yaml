name: Full Security Scan (Checkov + SonarCloud)

on:
  push:
    branches: [master]
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: üì• Checkout repository
        uses: actions/checkout@v2

      # Install .NET SDK
      - name: üß∞ Install .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # --- Checkov Installation ---
      - name: üîß Install Checkov
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          python3 -m venv checkov-env
          source checkov-env/bin/activate
          pip install checkov

      # Run Checkov - Infrastructure as Code (IaC) scan
      - name: üîç Run Checkov - Infrastructure as Code (IaC) scan
        run: |
          # Cambia './infraestructura' a la ruta de tus archivos IaC, por ejemplo:
          checkov -d ./infraestructura -o json > checkov-report.json || true

      # Upload Checkov report as artifact (using latest version of actions/upload-artifact)
      - name: üìä Upload Checkov report as artifact
        uses: actions/upload-artifact@v3
        with:
          name: checkov-report
          path: checkov-report.json

      # --- SonarCloud Integration ---
      - name: Set up SonarCloud
        uses: sonarsource/sonarcloud-github-action@v1
        with:
          sonarcloud_token: ${{ secrets.SONARCLOUD_TOKEN }}

      # Build and analyze with SonarCloud
      - name: üßë‚Äçüíª Build and analyze with SonarCloud
        run: |
          # Build project (por ejemplo, con .NET)
          dotnet build
          dotnet sonarscanner begin /k:"${{ secrets.SONAR_PROJECT_KEY }}" /d:sonar.login=${{ secrets.SONAR_TOKEN }}
          dotnet build
          dotnet sonarscanner end /d:sonar.login=${{ secrets.SONAR_TOKEN }}

      # --- Optional: Upload Checkov results to SonarCloud (if desired) ---
      # Esta parte es opcional si deseas agregar los resultados de Checkov directamente a SonarCloud:
      - name: Upload Checkov results to SonarCloud
        run: |
          # SonarCloud no tiene una integraci√≥n directa con Checkov, por lo que este paso es opcional.
          # Si quieres enviar los resultados de Checkov a SonarCloud, necesitar√°s una herramienta personalizada como "sonarcheckov".
          echo "Optional step for integration"
