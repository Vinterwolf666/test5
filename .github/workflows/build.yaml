name: Full Security Scan (Snyk Free License)

on:
  push:
    branches: [main]
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v2

      - name: 🧰 Install .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: 🛠 Install Snyk CLI
        run: |
          curl -Lo snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x ./snyk
          sudo mv ./snyk /usr/local/bin/snyk

      - name: 🔐 Authenticate with Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      # --- Dependency Scanning ---
      - name: 🔍 Snyk dependency test
        run: snyk test --all-projects --severity-threshold=low --json || true

      - name: 📊 Snyk monitor dependencies
        run: snyk monitor --all-projects || true

      # --- Code Scanning (workaround for separate target) ---
      - name: 🗂️ Prepare code folder
        run: |
          mkdir -p snyk-code
          rsync -ar --exclude='snyk-code' --exclude='snyk-iac' ./ snyk-code/

      - name: 🔎 Snyk code test
        run: snyk code test --path=snyk-code --json || true

      - name: 📊 Snyk monitor code
        run: snyk code monitor --path=snyk-code --project-name="${{ github.repository }}-code" || true

      # --- IaC Scanning (workaround for separate target) ---
      - name: 🗂️ Prepare iac folder
        run: |
          mkdir -p snyk-iac
          rsync -ar --exclude='snyk-code' --exclude='snyk-iac' ./ snyk-iac/

      - name: 🔍 Snyk Infrastructure as Code (IaC) test
        run: snyk iac test --all-projects --path=snyk-iac --json || true

      - name: 📊 Snyk Infrastructure as Code monitor
        run: snyk iac monitor --all-projects --path=snyk-iac --project-name="${{ github.repository }}-iac" || true
